# 🗄️ Database Layer - PostgreSQL Setup

**✅ OPERATIONAL** - This directory contains the **PostgreSQL database configuration** for the TasklistApp. The database runs in a Docker container and provides persistent storage for the Spring Boot API application.

![PostgreSQL](https://img.shields.io/badge/PostgreSQL-16-blue)
![Docker](https://img.shields.io/badge/Docker-Ready-blue)
![Status](https://img.shields.io/badge/Status-Operational-success)

## 📋 Table of Contents

- [🏗️ Database Overview](#-database-overview)
- [🚀 Current Status](#-current-status)
- [📁 Directory Structure](#-directory-structure)
- [🐳 Docker Configuration](#-docker-configuration)
- [🔧 Database Management](#-database-management)
- [✅ Persistence Verification](#-persistence-verification)
- [🔍 Monitoring & Maintenance](#-monitoring--maintenance)

## 🏗️ Database Overview

### Database Specifications
- **Database**: PostgreSQL 16 (Operational)
- **Container**: `tasklist-postgres` ✅ Running
- **Database Name**: `tasklistdb`
- **User**: `postgres`
- **Password**: `admin`
- **Port**: `5432`

### Key Features (All Operational)
- ✅ **Persistent Storage** - Docker volumes (`tasklistapp_postgres_data`)
- ✅ **Environment Configuration** - No hardcoded values
- ✅ **Health Checks** - Automatic readiness verification
- ✅ **Network Isolation** - Secure inter-container communication
- ✅ **Multi-Instance Ready** - Supports local + VM architecture
- ✅ **Production Security** - Configurable credentials

## 🚀 Current Status

### **🎯 Database is LIVE and Operational!**

| Component | Status | Details |
|-----------|--------|---------|
| **PostgreSQL Container** | ✅ Running | Version 16.10, Port 5432 |
| **Database Connection** | ✅ Active | tasklistdb created and accessible |
| **Persistent Storage** | ✅ Configured | Docker volume `tasklistapp_postgres_data` |
| **Table Schema** | ✅ Created | `task` table auto-generated by Hibernate |
| **Network Access** | ✅ Working | Inter-container communication |
| **Environment Config** | ✅ Loaded | All variables from docker-compose.yml |

### **📊 Live Database Metrics**
- **Connections**: Active HikariCP pool from Spring Boot
- **Storage**: Persistent Docker volume
- **Performance**: Optimized PostgreSQL 16
- **Backup**: Volume-based data persistence

### **🔗 Access Points**
- **Container**: `tasklist-postgres` (Docker network)
- **Host Access**: `localhost:5432` (port exposed)
- **Internal URL**: `jdbc:postgresql://tasklist-postgres:5432/tasklistdb`

## 🚀 Quick Start

### Start Database with Main Application
```bash
# From project root (recommended)
docker-compose up -d tasklist-postgres

# Or start entire application stack
docker-compose up -d --build
```

### Verify Database is Running
```bash
# Check container status
docker ps | grep postgres

# Check database connectivity
docker exec tasklist-postgres psql -U postgres -d tasklistdb -c "SELECT version();"

# List all databases
docker exec tasklist-postgres psql -U postgres -l
```

## 📁 Directory Structure

```
database/
├── 📄 README.md                 # This file - Database documentation
└── 📄 docker-compose.yml        # Legacy database setup (deprecated - use root docker-compose.yml)
```

## 🐳 Docker Configuration

### **Direct Configuration (Recommended)**
The database is configured directly in the main `docker-compose.yml` file:

```yaml
services:
  tasklist-postgres:
    image: postgres:16
    container_name: tasklist-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: tasklistdb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - tasklist-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d tasklistdb"]
      interval: 10s
      timeout: 5s
      retries: 5
```

### **Volume Persistence**
- **Volume Name**: `tasklistapp_postgres_data`
- **Storage Location**: Docker managed volume
- **Data Survival**: Container restarts, removals, crashes
- **Backup Ready**: Can be backed up and restored

## 🔧 Database Management

### Connect to Database
```bash
# Method 1: Docker exec (recommended)
docker exec -it tasklist-postgres psql -U postgres -d tasklistdb

# Method 2: Direct connection from host
psql -h localhost -p 5432 -U postgres -d tasklistdb

# Method 3: From host with password
PGPASSWORD=admin psql -h localhost -U postgres -d tasklistdb
```

### Common PostgreSQL Commands

#### Database Operations
```sql
-- List all databases
\l

-- Switch to tasklistdb
\c tasklistdb

-- List all tables
\dt

-- Describe table structure
\d task

-- Show table data
SELECT * FROM task;

-- Count records
SELECT COUNT(*) FROM task;
```

#### User Management
```sql
-- List all users
\du

-- Create new user (if needed)
CREATE USER newuser WITH PASSWORD 'password';

-- Grant permissions
GRANT ALL PRIVILEGES ON DATABASE tasklistdb TO newuser;
```

### Database Backup & Restore

#### Create Backup
```bash
# Backup entire database
docker exec tasklist-postgres pg_dump -U postgres tasklistdb > backup_$(date +%Y%m%d_%H%M%S).sql

# Backup specific table
docker exec tasklist-postgres pg_dump -U postgres -t task tasklistdb > task_table_backup.sql
```

#### Restore Database
```bash
# Restore from backup file
docker exec -i tasklist-postgres psql -U postgres -d tasklistdb < backup_file.sql

# Restore specific table data
docker exec -i tasklist-postgres psql -U postgres -d tasklistdb -c "\COPY task FROM 'task_data.csv' WITH CSV HEADER"
```

## ✅ Persistence Verification

### **Verify Data Consistency Between API and Database**
```bash
# Check data in PostgreSQL
docker exec -it tasklist-postgres psql -U postgres -d tasklistdb -c "SELECT id, title, completed FROM task ORDER BY id;"

# Check same data via API
curl -s http://localhost:8080/api/tasks | jq '.[] | {id, title, completed}'
```

**Expected Result:** Both commands should return identical data, confirming persistence works correctly.

### **Test Data Persistence**
```bash
# 1. Create a test task via API
curl -X POST http://localhost:8080/api/tasks \
  -H "Content-Type: application/json" \
  -d '{"title":"Persistence Test","completed":false}'

# 2. Verify it exists in database
docker exec -it tasklist-postgres psql -U postgres -d tasklistdb -c "SELECT * FROM task WHERE title = 'Persistence Test';"

# 3. Restart containers
docker-compose down && docker-compose up -d

# 4. Verify data still exists
docker exec -it tasklist-postgres psql -U postgres -d tasklistdb -c "SELECT COUNT(*) FROM task;"
```

## 🔍 Monitoring & Maintenance

### Container Monitoring
```bash
# View container logs
docker logs tasklist-postgres

# Monitor real-time logs
docker logs -f tasklist-postgres

# Check resource usage
docker stats tasklist-postgres
```

### Database Performance
```bash
# Check active connections
docker exec tasklist-postgres psql -U postgres -d tasklistdb -c "SELECT * FROM pg_stat_activity;"

# View table sizes
docker exec tasklist-postgres psql -U postgres -d tasklistdb -c "SELECT schemaname, tablename, attname, n_distinct FROM pg_stats WHERE tablename = 'task';"

# Check database size
docker exec tasklist-postgres psql -U postgres -d tasklistdb -c "SELECT pg_size_pretty(pg_database_size('tasklistdb'));"
```

### Health Checks
```bash
# Test database connectivity
docker exec tasklist-postgres pg_isready -U postgres -d tasklistdb

# Check if container is healthy
docker inspect tasklist-postgres | grep -A 5 '"Health"'
```

## 🛠️ Troubleshooting

### Common Issues

**Container Won't Start**
```bash
# Check if port 5432 is in use
netstat -tulpn | grep :5432

# Stop conflicting PostgreSQL service
sudo systemctl stop postgresql  # Linux

# Remove existing container
docker rm -f tasklist-postgres
```

**Connection Refused**
```bash
# Check if container is running
docker ps | grep tasklist-postgres

# Check container logs for errors
docker logs tasklist-postgres

# Verify network connectivity
docker network ls
docker network inspect tasklistapp_tasklist-network
```

**Authentication Failed**
```bash
# Check environment variables
docker exec tasklist-postgres env | grep POSTGRES

# Verify user exists
docker exec tasklist-postgres psql -U postgres -c "\du"

# Reset password if needed
docker exec tasklist-postgres psql -U postgres -c "ALTER USER postgres PASSWORD 'newpassword';"
```

## 🔒 Security Considerations

### Production Security
```yaml
# Use strong passwords
POSTGRES_PASSWORD: "your-secure-password-here"

# Use secrets management in production
secrets:
  db_password:
    file: ./secrets/db_password.txt
```

### Network Security
- Database port only exposed to necessary services
- Use Docker networks for service isolation
- Avoid exposing database port to host in production

### Access Control
```sql
-- Create read-only user for application
CREATE USER app_user WITH PASSWORD 'secure-password';
GRANT CONNECT ON DATABASE tasklistdb TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
```

## 🚀 Production Deployment

### Scaling Considerations
- **Read Replicas**: Add for read-heavy workloads
- **Connection Pooling**: Use PgBouncer for high concurrency
- **Backup Strategy**: Automated daily backups to S3/cloud storage

### High Availability
```yaml
# Example: PostgreSQL with replication
services:
  postgres-primary:
    # Primary database config

  postgres-replica:
    # Replica configuration
```

### Backup Strategy
```bash
# Automated backup script
#!/bin/bash
BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup
docker exec tasklist-postgres pg_dump -U postgres tasklistdb > $BACKUP_DIR/backup_$DATE.sql

# Upload to cloud storage
aws s3 cp $BACKUP_DIR/backup_$DATE.sql s3://your-bucket/backups/
```

## 📊 Database Schema

### Current Tables

#### `task` Table (Auto-Generated by Hibernate)
```sql
CREATE TABLE task (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    due_date DATE
);
```

### Schema Evolution
- **Auto-migration**: Hibernate handles schema updates via `JPA_DDL_AUTO=update`
- **Manual changes**: Can be added via SQL scripts if needed
- **Version control**: Schema changes tracked through JPA entity modifications

## 🤝 Maintenance Tasks

### Regular Maintenance
1. **Weekly**: Review and archive old logs
2. **Monthly**: Check disk space usage
3. **Quarterly**: Review and optimize slow queries
4. **Yearly**: Plan database upgrades and security updates

### Performance Optimization
```sql
-- Analyze table statistics
ANALYZE task;

-- Reindex if needed
REINDEX TABLE task;

-- View slow queries
SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;
```

## 📄 Related Documentation

- **Main Project**: [../README.md](../README.md) - Complete project overview
- **Spring Boot App**: [../app/README.md](../app/README.md) - Application development guide
- **VM Deployment**: [../vm/README.md](../vm/README.md) - VM deployment guide

---

**🗄️ Database Management Made Easy!** PostgreSQL + Docker = 🚀