name: Version Management - Tag Images

on:
  workflow_run:
    workflows: ["Build & Push Images"]
    types:
      - completed
  workflow_dispatch:

jobs:
  manage-versions:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get build workflow run number
        id: version
        run: |
          # Use the build workflow's run number from the trigger
          echo "CURRENT_RUN=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
          echo "PREVIOUS_RUN=$(( ${{ github.event.workflow_run.run_number }} - 1 ))" >> $GITHUB_OUTPUT

      - name: Retag previous version as pv1
        run: |
          echo "Retagging previous API version ${{ steps.version.outputs.PREVIOUS_RUN }} as pv1..."
          
          # Check if previous API image exists before pulling
          if docker manifest inspect ghcr.io/slmakomazi/tasklistapp:api-${{ steps.version.outputs.PREVIOUS_RUN }} >/dev/null 2>&1; then
            echo "Previous API image found, retagging..."
            # Pull previous API image
            docker pull ghcr.io/slmakomazi/tasklistapp:api-${{ steps.version.outputs.PREVIOUS_RUN }}
            
            # Retag as pv1
            docker tag ghcr.io/slmakomazi/tasklistapp:api-${{ steps.version.outputs.PREVIOUS_RUN }} ghcr.io/slmakomazi/tasklistapp:api-pv1
            
            # Push pv1 tag
            docker push ghcr.io/slmakomazi/tasklistapp:api-pv1
          else
            echo "Previous API image not found, skipping pv1 retag"
          fi
          
          echo "Retagging previous Frontend version ${{ steps.version.outputs.PREVIOUS_RUN }} as pv1..."
          
          # Check if previous Frontend image exists before pulling
          if docker manifest inspect ghcr.io/slmakomazi/tasklistapp:frontend-${{ steps.version.outputs.PREVIOUS_RUN }} >/dev/null 2>&1; then
            echo "Previous Frontend image found, retagging..."
            # Pull previous frontend image
            docker pull ghcr.io/slmakomazi/tasklistapp:frontend-${{ steps.version.outputs.PREVIOUS_RUN }}
            
            # Retag as pv1
            docker tag ghcr.io/slmakomazi/tasklistapp:frontend-${{ steps.version.outputs.PREVIOUS_RUN }} ghcr.io/slmakomazi/tasklistapp:frontend-pv1
            
            # Push pv1 tag
            docker push ghcr.io/slmakomazi/tasklistapp:frontend-pv1
          else
            echo "Previous Frontend image not found, skipping pv1 retag"
          fi
          
          echo "Retagging previous Database version ${{ steps.version.outputs.PREVIOUS_RUN }} as pv1..."
          
          # Check if previous Database image exists before pulling
          if docker manifest inspect ghcr.io/slmakomazi/tasklistapp:db-${{ steps.version.outputs.PREVIOUS_RUN }} >/dev/null 2>&1; then
            echo "Previous Database image found, retagging..."
            # Pull previous database image
            docker pull ghcr.io/slmakomazi/tasklistapp:db-${{ steps.version.outputs.PREVIOUS_RUN }}
            
            # Retag as pv1
            docker tag ghcr.io/slmakomazi/tasklistapp:db-${{ steps.version.outputs.PREVIOUS_RUN }} ghcr.io/slmakomazi/tasklistapp:db-pv1
            
            # Push pv1 tag
            docker push ghcr.io/slmakomazi/tasklistapp:db-pv1
          else
            echo "Previous Database image not found, skipping pv1 retag"
          fi

      - name: Ensure current version is tagged as latest
        run: |
          echo "Ensuring current version ${{ steps.version.outputs.CURRENT_RUN }} is tagged as latest..."
          
          # Check if current API image exists before pulling
          if docker manifest inspect ghcr.io/slmakomazi/tasklistapp:api-${{ steps.version.outputs.CURRENT_RUN }} >/dev/null 2>&1; then
            echo "Current API image found, tagging as latest..."
            # Pull current API image
            docker pull ghcr.io/slmakomazi/tasklistapp:api-${{ steps.version.outputs.CURRENT_RUN }}
            
            # Tag as latest
            docker tag ghcr.io/slmakomazi/tasklistapp:api-${{ steps.version.outputs.CURRENT_RUN }} ghcr.io/slmakomazi/tasklistapp:api-latest
            
            # Push latest tag
            docker push ghcr.io/slmakomazi/tasklistapp:api-latest
          else
            echo "Current API image not found, skipping latest tag"
          fi
          
          echo "Ensuring current Frontend version ${{ steps.version.outputs.CURRENT_RUN }} is tagged as latest..."
          
          # Tag current Frontend version as latest
          echo "Tagging Frontend version ${{ steps.version.outputs.CURRENT_RUN }} as latest..."
          # Pull current frontend image
          docker pull ghcr.io/slmakomazi/tasklistapp:frontend-${{ steps.version.outputs.CURRENT_RUN }} || echo "Pull failed, trying direct tag..."
          
          # Tag as latest
          docker tag ghcr.io/slmakomazi/tasklistapp:frontend-${{ steps.version.outputs.CURRENT_RUN }} ghcr.io/slmakomazi/tasklistapp:frontend-latest || echo "Tag failed, trying direct pull and tag..."
          
          # If tag failed, try pulling and tagging again
          if ! docker images | grep "frontend-latest" >/dev/null 2>&1; then
            docker pull ghcr.io/slmakomazi/tasklistapp:frontend-${{ steps.version.outputs.CURRENT_RUN }}
            docker tag ghcr.io/slmakomazi/tasklistapp:frontend-${{ steps.version.outputs.CURRENT_RUN }} ghcr.io/slmakomazi/tasklistapp:frontend-latest
          fi
          
          # Push latest tag
          docker push ghcr.io/slmakomazi/tasklistapp:frontend-latest
          
          echo "Ensuring current Database version ${{ steps.version.outputs.CURRENT_RUN }} is tagged as latest..."
          
          # Check if current Database image exists before pulling
          if docker manifest inspect ghcr.io/slmakomazi/tasklistapp:db-${{ steps.version.outputs.CURRENT_RUN }} >/dev/null 2>&1; then
            echo "Current Database image found, tagging as latest..."
            # Pull current database image
            docker pull ghcr.io/slmakomazi/tasklistapp:db-${{ steps.version.outputs.CURRENT_RUN }}
            
            # Tag as latest
            docker tag ghcr.io/slmakomazi/tasklistapp:db-${{ steps.version.outputs.CURRENT_RUN }} ghcr.io/slmakomazi/tasklistapp:db-latest
            
            # Push latest tag
            docker push ghcr.io/slmakomazi/tasklistapp:db-latest
          else
            echo "Current Database image not found, skipping latest tag"
          fi

      - name: Clean up old numbered tags (keep only latest and pv1)
        run: |
          echo "Cleaning up old numbered tags older than pv1..."
          
          # Remove API tags older than pv1 (keep current and previous)
          OLD_API_RUN=$(( ${{ github.run_number }} - 2 ))
          if [ $OLD_API_RUN -gt 0 ]; then
            echo "Removing API tag: api-$OLD_API_RUN"
            docker rmi ghcr.io/slmakomazi/tasklistapp:api-$OLD_API_RUN || true
          fi
          
          # Remove Frontend tags older than pv1 (keep current and previous)  
          OLD_FRONTEND_RUN=$(( ${{ github.run_number }} - 2 ))
          if [ $OLD_FRONTEND_RUN -gt 0 ]; then
            echo "Removing Frontend tag: frontend-$OLD_FRONTEND_RUN"
            docker rmi ghcr.io/slmakomazi/tasklistapp:frontend-$OLD_FRONTEND_RUN || true
          fi
          
          # Remove Database tags older than pv1 (keep current and previous)  
          OLD_DB_RUN=$(( ${{ github.run_number }} - 2 ))
          if [ $OLD_DB_RUN -gt 0 ]; then
            echo "Removing Database tag: db-$OLD_DB_RUN"
            docker rmi ghcr.io/slmakomazi/tasklistapp:db-$OLD_DB_RUN || true
          fi

      - name: Display current tags
        run: |
          echo "Current image tags after version management:"
          echo ""
          echo "API Images:"
          echo "  - api-latest (current version: ${{ steps.version.outputs.CURRENT_RUN }})"
          echo "  - api-pv1 (previous version: ${{ steps.version.outputs.PREVIOUS_RUN }})"
          echo ""
          echo "Frontend Images:"
          echo "  - frontend-latest (current version: ${{ steps.version.outputs.CURRENT_RUN }})"
          echo "  - frontend-pv1 (previous version: ${{ steps.version.outputs.PREVIOUS_RUN }})"
          echo ""
          echo "Database Images:"
          echo "  - db-latest (current version: ${{ steps.version.outputs.CURRENT_RUN }})"
          echo "  - db-pv1 (previous version: ${{ steps.version.outputs.PREVIOUS_RUN }})"
