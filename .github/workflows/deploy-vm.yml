name: Deploy to VM

on:
  workflow_run:
    workflows: ["Backend CI - Build & Push Image"]
    types: [completed]
  workflow_dispatch:

env:
  TARGET_DIR: /opt/tasklistapp

jobs:
  deploy:
    name: Deploy to Self-Hosted VM
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Create target directory
        run: |
          sudo mkdir -p ${{ env.TARGET_DIR }}
          sudo chown -R $USER:$USER ${{ env.TARGET_DIR }}

      - name: Copy Ansible files
        run: |
          cp -r ansible/ ${{ env.TARGET_DIR }}/
          chmod 600 ${{ env.TARGET_DIR }}/ansible/group_vars/all/vault.yml

      - name: Run Ansible playbook
        working-directory: ${{ env.TARGET_DIR }}/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          ansible-playbook -i inventory.ini deploy_vm.yml --vault-password-file <(echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}")

      - name: Start containers
        run: |
          cd ${{ env.TARGET_DIR }}
          docker-compose up -d

      - name: Verify containers
        run: |
          docker ps
          echo 'Deployment completed successfully!'

      - name: Verify deployment
        run: |
          ssh -p ${{ env.DEPLOY_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "
            docker ps
            docker-compose logs --tail=10
          "