name: Deploy to VM

on:
  workflow_run:
    workflows: ["Backend CI - Build & Push Image"]
    types: [completed]
  workflow_dispatch:

env:
  TARGET_DIR: /opt/tasklistapp

jobs:
  deploy:
    name: Deploy to Self-Hosted VM
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible sshpass

      - name: Create Work Directory
        run: |
          sudo mkdir -p ${{ env.TARGET_DIR }}
          sudo chown -R $USER:$USER ${{ env.TARGET_DIR }}

      - name: Copy Ansible Files
        run: |
          cp -r ansible/ ${{ env.TARGET_DIR }}/

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          
      - name: Create Ansible Vault Password File
        run: |
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > ~/.vault_pass.txt
          chmod 600 ~/.vault_pass.txt

      - name: Run Ansible Playbook (Deploy to VM)
        working-directory: ${{ env.TARGET_DIR }}/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          ansible-playbook \
            -i inventory.ini \
            deploy_vm.yml \
            --vault-password-file ~/.vault_pass.txt

      - name: Start Docker Compose on VM
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "cd /opt/tasklistapp && docker-compose up -d"

      - name: Verify deployment on VM
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "docker ps && docker-compose logs --tail=20"