name: Deploy to VM

on:
  workflow_run:
    workflows: ["Backend CI - Build & Push Image"]
    types: [completed]
  workflow_dispatch:

env:
  # Target directory on the VM
  TARGET_DIR: /opt/tasklistapp
  # Absolute paths for runner's home directory (siseko is the runner user)
  RUNNER_HOME: /home/siseko
  SSH_DIR: /home/siseko/.ssh
  VAULT_PASS_PATH: /home/siseko/.vault_pass.txt

jobs:
  deploy:
    name: Deploy to Self-Hosted VM
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Ansible and sshpass using password from GitHub Secrets
      - name: Install Ansible and sshpass
        run: |
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S apt-get update -y
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S apt-get install -y ansible sshpass

      # Create target directory on VM host and ensure runner user owns it
      - name: Create Work Directory and Set Permissions
        run: |
          # Combined mkdir and chown using sudo for reliability
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S bash -c "
            mkdir -p ${{ env.TARGET_DIR }} && \
            chown -R $USER:$USER ${{ env.TARGET_DIR }}
          "

      # Copy Ansible files to target directory
      - name: Copy Ansible Files
        run: |
          cp -r ansible/ ${{ env.TARGET_DIR }}/

      # Fix for Exit Code 1: Ensure SSH directory exists and is owned by the runner user
      - name: Setup Directories and Permissions (Guaranteed Writable)
        run: |
          # ðŸš¨ FIX FOR EXIT CODE 1: Use sudo to create/chown the SSH directory to the runner user.
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S bash -c "
            mkdir -p ${{ env.SSH_DIR }} && \
            chown -R $USER:$USER ${{ env.SSH_DIR }}
          "
          # Set strict permissions (700)
          chmod 700 ${{ env.SSH_DIR }}
          
          # Ensure vault password file has correct permissions
          touch ${{ env.VAULT_PASS_PATH }}
          chmod 600 ${{ env.VAULT_PASS_PATH }}

      # Setup SSH key with proper permissions
      - name: Setup SSH Key
        run: |
          # Write private key with secure permissions (This should now pass)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ${{ env.SSH_DIR }}/id_rsa
          chmod 600 ${{ env.SSH_DIR }}/id_rsa
          
          # Update known_hosts with appropriate permissions
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ${{ env.SSH_DIR }}/known_hosts
          chmod 644 ${{ env.SSH_DIR }}/known_hosts

      # Create Ansible Vault password file with secure permissions
      - name: Create Ansible Vault Password File
        run: |
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > ${{ env.VAULT_PASS_PATH }}
          chmod 600 ${{ env.VAULT_PASS_PATH }}

      # Run Ansible playbook as the siseko user
      - name: Run Ansible Playbook (Deploy to VM)
        working-directory: ${{ env.TARGET_DIR }}/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
          HOME: ${{ env.RUNNER_HOME }}  # Ensure HOME is set correctly for ssh-agent lookup
        run: |
          # ðŸš¨ FIX FOR ANSIBLE SYNTAX: Ensure all environment variables are correctly passed as arguments to bash -c.
          # Arguments: $0=PWD, $1=VAULT_PATH, $2=SSH_KEY_PATH
          sudo -u siseko bash -c '
            cd "$0" && \
            ansible-playbook \
              -i inventory.ini \
              deploy_vm.yml \
              --vault-password-file "$1" \
              --private-key "$2"
          ' "$PWD" "${{ env.VAULT_PASS_PATH }}" "${{ env.SSH_DIR }}/id_rsa"

      # Start Docker Compose on VM using the configured SSH key
      - name: Start Docker Compose on VM
        run: |
          ssh -o StrictHostKeyChecking=no \
              -i ${{ env.SSH_DIR }}/id_rsa \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "cd ${{ env.TARGET_DIR }} && docker-compose up -d"

              
      # Verify deployment on VM
      - name: Verify deployment on VM
        run: |
          ssh -o StrictHostKeyChecking=no \
              -i ${{ env.SSH_DIR }}/id_rsa \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "cd ${{ env.TARGET_DIR }} && \
              echo 'Containers:' && docker ps && \
              echo -e '\nLogs:' && docker-compose logs --tail=20"