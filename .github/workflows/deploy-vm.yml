name: Deploy to VM

on:
  workflow_run:
    workflows: ["Backend CI - Build & Push Image"]
    types: [completed]
  workflow_dispatch:

env:
  TARGET_DIR: /opt/tasklistapp
  RUNNER_HOME: /home/siseko
  SSH_DIR: /home/siseko/.ssh
  VAULT_PASS_PATH: /home/siseko/.vault_pass.txt

jobs:
  deploy:
    name: Deploy to Self-Hosted VM
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Wait for any apt locks to be released
      - name: Wait for apt lock
        run: |
          timeout=300
          echo "Checking for apt locks..."
          while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
                sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
                sudo fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
            echo "Waiting for apt lock to be released..."
            sleep 5
            timeout=$((timeout-5))
            if [ $timeout -le 0 ]; then
              echo "Timeout waiting for apt lock. Attempting to continue..."
              break
            fi
          done
          echo "Apt lock check complete"

      # Install dependencies only if not already present
      - name: Ensure Ansible and sshpass are installed
        run: |
          if ! command -v ansible &> /dev/null || ! command -v sshpass &> /dev/null; then
            echo "Installing Ansible and sshpass..."
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S apt-get update -y
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S apt-get install -y ansible sshpass
          else
            echo "Ansible and sshpass already installed"
          fi

      # Create folder for deployment
      - name: Create Work Directory and Set Permissions
        run: |
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S mkdir -p ${{ env.TARGET_DIR }}
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S chown -R siseko:siseko ${{ env.TARGET_DIR }}

      # Copy ansible folder to target
      - name: Copy Ansible Files
        run: cp -r ansible/ ${{ env.TARGET_DIR }}/

      # Configure SSH environment
      - name: Setup SSH Environment
        run: |
          mkdir -p ${{ env.SSH_DIR }}
          chmod 700 ${{ env.SSH_DIR }}

          # Save SSH private key
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ${{ env.SSH_DIR }}/id_rsa
          chmod 600 ${{ env.SSH_DIR }}/id_rsa

          # Add host key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ${{ env.SSH_DIR }}/known_hosts
          chmod 644 ${{ env.SSH_DIR }}/known_hosts

          # Write Ansible vault password
          printf "%s\n" "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > ${{ env.VAULT_PASS_PATH }}
          chmod 600 ${{ env.VAULT_PASS_PATH }}

      # Run Ansible
      - name: Run Ansible Playbook (Deploy to VM)
        working-directory: ${{ env.TARGET_DIR }}/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
          HOME: ${{ env.RUNNER_HOME }}
        run: |
          ansible-playbook \
            -i inventory.ini \
            deploy_vm.yml \
            --vault-password-file "${{ env.VAULT_PASS_PATH }}" \
            --private-key "${{ env.SSH_DIR }}/id_rsa"

      # Start Docker Compose on VM
      - name: Start Docker Compose on VM
        run: |
          ssh -o StrictHostKeyChecking=no \
              -i ${{ env.SSH_DIR }}/id_rsa \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "cd ${{ env.TARGET_DIR }} && docker-compose up -d"

      # Verify containers
      - name: Verify deployment on VM
        run: |
          ssh -o StrictHostKeyChecking=no \
              -i ${{ env.SSH_DIR }}/id_rsa \
              ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
              "cd ${{ env.TARGET_DIR }} && \
               echo 'Containers:' && docker ps && \
               echo -e '\nLogs:' && docker-compose logs --tail=20"