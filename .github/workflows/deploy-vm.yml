name: Deploy to VM with Ansible

on:
  workflow_run:
    workflows: ["Backend CI - Build & Push Image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual trigger'

env:
  DEPLOY_USER: siseko
  DEPLOY_HOST: localhost
  DEPLOY_PORT: 2222
  TARGET_DIR: /opt/tasklistapp

jobs:
  deploy:
    name: Deploy to WSL VM
    runs-on: ubuntu-latest
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      (github.event_name == 'workflow_dispatch' || github.event.workflow_run.event.workflow == 'Backend CI - Build & Push Image')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Add SSH config
        run: |
          mkdir -p ~/.ssh
          echo "Host wsl-vm" >> ~/.ssh/config
          echo "  HostName ${{ env.DEPLOY_HOST }}" >> ~/.ssh/config
          echo "  Port ${{ env.DEPLOY_PORT }}" >> ~/.ssh/config
          echo "  User ${{ env.DEPLOY_USER }}" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Test SSH connection
        run: ssh wsl-vm "echo 'SSH connection successful!'"

      - name: Create target directory
        run: |
          ssh wsl-vm "sudo mkdir -p ${{ env.TARGET_DIR }}"
          ssh wsl-vm "sudo chown ${{ env.DEPLOY_USER }}:${{ env.DEPLOY_USER }} ${{ env.TARGET_DIR }}"

      - name: Copy files to WSL VM
        run: |
          scp -r -P ${{ env.DEPLOY_PORT }} ./build/* ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.TARGET_DIR }}/

      - name: Restart application
        run: ssh wsl-vm "sudo systemctl restart tasklistapp.service"

      - name: Verify deployment
        run: echo "Deployment completed successfully!"