apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - namespace.yaml
  - serviceaccount.yaml
  - ghcr-secret.yaml
  - postgres-manifests/postgres-configmap.yaml
  - postgres-manifests/postgres-service.yaml
  - postgres-manifests/postgres-deployment.yaml
  - postgres-manifests/postgres-pvc.yaml
  - frontend-manifests/frontend-configmap.yaml
  - frontend-manifests/frontend-service.yaml
  - frontend-manifests/frontend-deployment.yaml
  - backend-manifests/backend-configmap.yaml
  - backend-manifests/backend-secrets.yaml
  - backend-manifests/backend-service.yaml
  - backend-manifests/backend-deployment.yaml
  - ingress/frontend-ingress.yaml
  - ingress/backend-ingress.yaml

# Common labels for all resources
commonLabels:
  app.kubernetes.io/part-of: tasklistapp
  app.kubernetes.io/managed-by: argocd

# Common annotations for all resources
commonAnnotations:
  argocd.argoproj.io/sync-options: PruneLast=true
  argocd.argoproj.io/sync-wave: "0"

# Image overrides
images:
  - name: ghcr.io/slmakomazi/tasklistapp-frontend
    newName: ghcr.io/slmakomazi/tasklistapp-frontend
    newTag: latest
  - name: ghcr.io/slmakomazi/tasklistapp
    newName: ghcr.io/slmakomazi/tasklistapp
    newTag: api-latest

# Prevent Kustomize from modifying selectors
patches:
  - target:
      kind: Deployment
      name: frontend
    patch: |-
      - op: replace
        path: /spec/selector/matchLabels
        value:
          app: frontend
      - op: replace
        path: /spec/template/metadata/labels
        value:
          app: frontend
          app.kubernetes.io/name: frontend
          app.kubernetes.io/instance: frontend
          app.kubernetes.io/version: "1.0.0"
  - target:
      kind: Deployment
      name: tasklistapp-deployment
    patch: |-
      - op: replace
        path: /spec/selector/matchLabels
        value:
          app: tasklistapp
      - op: replace
        path: /spec/template/metadata/labels
        value:
          app: tasklistapp
          app.kubernetes.io/name: tasklistapp
          app.kubernetes.io/instance: tasklistapp
          app.kubernetes.io/version: "1.0.0"
